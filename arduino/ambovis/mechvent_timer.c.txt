/** Mechanical ventilation.
 *
 * @file MechVentilation.cpp
 *
 * This is the mechanical ventilation software module.
 * It handles the mechanical ventilation control loop.
 */
#include <float.h>
#include "calc.h"
#include "MechVentilation.h"
#include "src/AccelStepper/AccelStepper.h"

#define DEBUG 1

/** No trigger. */
#define LPM_FLUX_TRIGGER_VALUE_NONE     FLT_MAX

MechVentilation::MechVentilation(
    PID pid,    //TODO Check????
    AccelStepper stepper,
//    Adafruit_BMP280_Pressure bmp1,
//    Adafruit_BMP280_Pressure bmp2,
    Pressure_Sensor bmp1,
    Pressure_Sensor bmp2,
    float mlTidalVolume,
    float secTimeoutInsufflation,
    float secTimeoutExsufflation,
    float speedInsufflation,
    float speedExsufflation
)

{
    _init(pid,
          stepper,
          bmp1,
          bmp2,
          mlTidalVolume,
          secTimeoutInsufflation,
          secTimeoutExsufflation,
          speedInsufflation,
          speedExsufflation,
          LPM_FLUX_TRIGGER_VALUE_NONE);

   
}

MechVentilation::MechVentilation()
{}

MechVentilation::MechVentilation(
    PID pid,    //TODO Check????
    AccelStepper stepper,
//    Adafruit_BMP280_Pressure bmp1,
//    Adafruit_BMP280_Pressure bmp2,
        Pressure_Sensor bmp1,
        Pressure_Sensor bmp2,
    float mlTidalVolume,
    float secTimeoutInsufflation,
    float secTimeoutExsufflation,
    float speedInsufflation,
    float speedExsufflation,
    float lpmFluxTriggerValue
)
{
    _init(pid,stepper,
          bmp1,
          bmp2,
          mlTidalVolume,
          secTimeoutInsufflation,
          secTimeoutExsufflation,
          speedInsufflation,
          speedExsufflation,
          lpmFluxTriggerValue);
}

void MechVentilation::setTidalVolume(float mlTidalVolume) {
    _cfgmlTidalVolume = mlTidalVolume;
}

void MechVentilation::setTimeoutInsufflation(float secTimeoutInsufflation) {
    _cfgSecTimeoutInsufflation = secTimeoutInsufflation;
}

void MechVentilation::setTimeoutExsufflation(float secTimeoutExsufflation) {
    _cfgSecTimeoutExsufflation = secTimeoutExsufflation;
}

void MechVentilation::setSpeedInsufflation(float speedInsufflation) {
    _speedInsufflation = _cfgSpeedInsufflation;
}

void MechVentilation::setSpeedExsufflation(float speedExsufflation) {
    _speedExsufflation = _cfgSpeedExsufflation;
}

void MechVentilation::start(void) {
    if(_cfgLpmFluxTriggerValue == LPM_FLUX_TRIGGER_VALUE_NONE) {
        _setState(State_StartInsufflation);
        #ifdef DEBUG
        Serial.println("Comenzando");
        #endif
    } else {
        /* Triggered */
        _setState(State_WaitTrigger);
    }
}

void MechVentilation::stop(void) {
    _setState(State_Shutdown);
}

int MechVentilation::getState()
{
  return _currentState;  
}

void MechVentilation::update(void) {
bool bContinue = false;
//    do {
      
  _msecTimerCnt=(unsigned long)(millis()-_msecTimerStartCycle);
        Serial.println(_currentState);   

        Serial.print("startcycle: ");Serial.println(      _msecTimerStartCycle);
        bContinue = false;
#ifdef DEBUG
        Serial.print("_secTimerCnt: ");Serial.println(_msecTimerCnt);
#endif        
        switch(_currentState) {
            case State_WaitTrigger : {
                /* @todo Uncomment on trigger condition */
#if 0
                _setState(State_StartInsufflation);
                /* Step directly into next case */
                bContinue = true;
#endif
            }
            break;

            case State_StartInsufflation : {
#ifdef DEBUG
        Serial.println("Start Insufflation");
        Serial.println(_msecTimeoutInsufflation);
        
#endif
                _msecTimerStartCycle=millis();  //Luciano
                //_msecTimerCnt            = 0;
                //_msecTimeoutInsufflation = millis()_cfgSecTimeoutInsufflation;
                //_msecTimeoutExsufflation = _secTimeoutExsufflation;
                
                _speedInsufflation      = _cfgSpeedInsufflation;
                _speedExsufflation      = _speedExsufflation;

                /* @todo start PID stuff? */
                _setState(State_Insufflation);
                //stepper->setMaxSpeed(_speedInsufflation);
                //stepper->move(200);                
                /* Step directly into next case */
                bContinue = true;
            }
            break;

            case State_Insufflation : {
                if(_msecTimerCnt < _msecTimeoutInsufflation) {
                    /* @todo Keep on the PID work */
#ifdef ADA_PRESS
                    // Acquire sensors data
                    //_cfgBmp1->getEvent(&_pressure1Event);
                    //_cfgBmp2->getEvent(&_pressure2Event);
                    _cfgBmp1.getEvent(&_pressure1Event);
                    _cfgBmp2.getEvent(&_pressure2Event);
                    _pressure1 = _pressure1Event.pressure;
                    _pressure2 = _pressure2Event.pressure;
#else
                   
#endif
                    // Calculate flux from delta pressure
                    // TODO: Check sign of results!
                      //calcularCaudal(&_pressure1, &_pressure2, &_flux);
                      //calcularCaudalVenturi(&_pressure1, &_pressure2, &_flux);
//                    //float _mlmsFlow,_mlmsprevFlow;  
                      float dt=(float)(_msecTimerCnt-_msecLastUpdate)*1000.;
                      _mlInsVol+=_flux*dt;
//
//                    //Si es mayor al driver dt
                   if (dt>_cfgpid->get_dt()){
                     //OPCIONES: 1 SETPOINT FIJO: FLUJO CONSTANTE
                     //OPCION 2 Corrijo el setpoint 
                     float speed;
                     //Calculo como set point el flujo para el volumen que queda
                     float rem_flux=(_cfgmlTidalVolume-_mlInsVol)/(float)(_msecTimeoutInsufflation-_msecTimerCnt);
                     //pid.calculate( double setpoint, double pv );                      
                     //speed=_cfgpid->calculate(rem_flux, (double)_flux);
                     
                     //stepper->setMaxSpeed(speed);
                     //stepper->move(200);     //ESTO VA??    
                   }
                    

                    //float desired_flow=_mlInsVol/;
    
                    // TODO: Control stepper velocity from flux

                } else {
                    /* Insufflation timeout expired */
                    //_msecTimerCnt = 0;
                    _setState(State_StopInsufflation);
                    #ifdef DEBUG
                    Serial.println("stop insuflation");
                    #endif
                    /* Step directly into next case */
                    bContinue = true;
                }
            }
            break;

            case State_StopInsufflation : {
                /* @todo Stop PID stuff? */
                /* @todo Start exsufflation timer */
                //stepper->setMaxSpeed(0);
                //stepper->move(0);

                _msecTimerStartCycle=millis();
                _setState(State_WaitExsufflation);
                /* Step directly into next case */
                bContinue = true;
            }
            break;

            case State_WaitExsufflation : {
                if(_msecTimerCnt < _msecTimeoutExsufflation) {
                    /* @todo Mover leva hacia arriba sin controlar y/o esperar */
                } else {
                    /* Exsufflation timeout expired */
                    if(_cfgLpmFluxTriggerValue == LPM_FLUX_TRIGGER_VALUE_NONE) {
                        _setState(State_StartInsufflation);
                    } else {
                        /* Triggered */
                        _setState(State_WaitTrigger);
                    }
                    bContinue = true;
                }
            }
            break;

            case State_Shutdown : {
                /* @todo Shutdown in a safe way!!! */

                _init(*_cfgpid,
                      *_cfgStepper,
                      _cfgBmp1,
                      _cfgBmp2,
                      _cfgmlTidalVolume,
                      _cfgSecTimeoutInsufflation,
                      _cfgSecTimeoutExsufflation,
                      _cfgSpeedInsufflation,
                      _cfgSpeedExsufflation,
                      _cfgLpmFluxTriggerValue);
            }

            default :{
                /* State_Init
                * State_Idle
                *
                * Do nothing.
                */
            }
            break;
        }
//    } while (bContinue = true);
  _msecLastUpdate=_msecTimerCnt;
}

void MechVentilation::_init(
    PID pid,
    AccelStepper stepper,
//    Adafruit_BMP280_Pressure bmp1,
//    Adafruit_BMP280_Pressure bmp2,
        Pressure_Sensor bmp1,
        Pressure_Sensor bmp2,
    float mlTidalVolume,
    float secTimeoutInsufflation,
    float secTimeoutExsufflation,
    float speedInsufflation,
    float speedExsufflation,
    float lpmFluxTriggerValue
)
{
    /* Set configuration parameters */
    _cfgpid                     =&pid;
    _cfgStepper                 = &stepper;
    _cfgBmp1                    = bmp1;
    _cfgBmp2                    = bmp2;
    _cfgmlTidalVolume           = mlTidalVolume;
    _cfgSecTimeoutInsufflation  = secTimeoutInsufflation;
    _cfgSecTimeoutExsufflation  = secTimeoutExsufflation;
    _cfgSpeedInsufflation       = speedInsufflation;
    _cfgSpeedExsufflation       = speedExsufflation;
    _cfgLpmFluxTriggerValue     = lpmFluxTriggerValue;

    /* Initialize internal state */
    _previousState          = State_Init;
    _currentState           = State_Idle;
    _nextState              = State_Idle;
    //_msecTimerCnt            = millis();
    _msecTimeoutInsufflation = (int)(_cfgSecTimeoutInsufflation*1000.);
    _msecTimeoutExsufflation = (int)(_cfgSecTimeoutExsufflation*1000.);
    _speedInsufflation      = 0;
    _speedExsufflation      = 0;

    //Calculo porcentaje inicial APROXIMADO DEL EMPUJADOR
    disp_perc=_cfgmlTidalVolume/DEFAULT_MAX_VOLUMEN_TIDAL;

    #ifdef DEBUG
        Serial.print("_cfgSecTimeoutInsufflation: ");Serial.println(_cfgSecTimeoutInsufflation);
        Serial.print("_cfgSecTimeoutExsufflation: ");Serial.println(_cfgSecTimeoutExsufflation);
        Serial.print("_msecTimeoutInsufflation: ");Serial.println(_msecTimeoutInsufflation);
        Serial.print("_msecTimeoutExsufflation: ");Serial.println(_msecTimeoutExsufflation);
        Serial.print("Tamaño de unsigned short: ");Serial.println(sizeof(_msecTimerCnt));
    #endif   
}

void MechVentilation::_setState(State state) {
    _previousState  = _currentState;
    _currentState   = state;
}